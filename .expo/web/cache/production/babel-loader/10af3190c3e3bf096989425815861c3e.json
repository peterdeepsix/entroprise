{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";import React,{useEffect,useState,useRef}from\"react\";import Loadable from\"@loadable/component\";import firebase from\"gatsby-plugin-firebase\";import{useAuthState}from\"react-firebase-hooks/auth\";import*as facemesh from\"@tensorflow-models/facemesh\";import*as tf from\"@tensorflow/tfjs-core\";import*as tfjsWasm from\"@tensorflow/tfjs-backend-wasm\";import{makeStyles}from\"@material-ui/core/styles\";import{Container,Box,Typography,Button,Card,CardContent,CardHeader,CardActions,IconButton,List,ListItem,ListItemSecondaryAction,ListItemText,ListItemAvatar,Avatar}from\"@material-ui/core\";import IndefiniteLoading from\"src/components/loading/indefiniteLoading\";var UsersList=Loadable(function(){return import(\"./UsersList\");},{fallback:React.createElement(IndefiniteLoading,{message:\"UsersList\"})});var RoomDialog=Loadable(function(){return import(\"./RoomDialog\");},{fallback:React.createElement(IndefiniteLoading,{message:\"RoomDialog\"})});var LocalTracks=Loadable(function(){return import(\"./LocalTracks\");},{fallback:React.createElement(IndefiniteLoading,{message:\"LocalTracks\"})});var useStyles=makeStyles(function(theme){return{video:{width:\"100%\"}};});var WebRTC=function WebRTC(){var classes=useStyles();var _useState=useState(null),_useState2=_slicedToArray(_useState,2),mediaStream=_useState2[0],setMediaStream=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),isOnline=_useState4[0],setIsOnline=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),isPredicting=_useState6[0],setIsPredicting=_useState6[1];var videoRef=useRef();var handleClickUser=function handleClickUser(){console.log(\"call user\");};var handleDetectFaces=function handleDetectFaces(){var model,current,predictions;return _regeneratorRuntime.async(function handleDetectFaces$(_context){while(1){switch(_context.prev=_context.next){case 0:setIsPredicting(true);_context.next=3;return _regeneratorRuntime.awrap(facemesh.load());case 3:model=_context.sent;current=videoRef.current;_context.next=7;return _regeneratorRuntime.awrap(model.estimateFaces(current));case 7:predictions=_context.sent;if(predictions.length>0){predictions.forEach(function(prediction){if(prediction.faceInViewConfidence>=0.8)setIsOnline(true);if(prediction.faceInViewConfidence<0.8)setIsOnline(false);});}setIsPredicting(false);case 10:case\"end\":return _context.stop();}}},null,null,null,Promise);};function handleCanPlay(){videoRef.current.play();handleDetectFaces();}useEffect(function(){function enableStream(){var stream;return _regeneratorRuntime.async(function enableStream$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return _regeneratorRuntime.awrap(navigator.mediaDevices.getUserMedia({audio:false,video:true}));case 3:stream=_context2.sent;setMediaStream(stream);_context2.next=10;break;case 7:_context2.prev=7;_context2.t0=_context2[\"catch\"](0);console.log(_context2.t0);case 10:case\"end\":return _context2.stop();}}},null,null,[[0,7]],Promise);}if(!mediaStream){enableStream();}else{return function cleanup(){mediaStream.getTracks().forEach(function(track){track.stop();});};}},[mediaStream]);if(mediaStream&&videoRef.current&&!videoRef.current.srcObject){videoRef.current.srcObject=mediaStream;}return React.createElement(React.Fragment,null,React.createElement(Box,{mt:2,mb:1},React.createElement(Card,{variant:\"outlined\"},React.createElement(CardHeader,{title:\"User Status\"}),React.createElement(\"video\",{className:classes.video,ref:videoRef,onCanPlay:handleCanPlay,autoPlay:true,playsInline:true,muted:true}),isPredicting&&React.createElement(IndefiniteLoading,{message:\"Presence\"}),React.createElement(CardContent,null,React.createElement(Box,null,React.createElement(Button,{variant:\"contained\",color:\"primary\",onClick:handleDetectFaces},\"ReCheck Presence\")),React.createElement(Box,{mt:2,mb:1},isOnline&&React.createElement(Typography,null,\"User is online\"))))),React.createElement(Box,{mt:2,mb:10},React.createElement(UsersList,{callUser:handleClickUser})));};export default WebRTC;","map":{"version":3,"sources":["C:/Users/arnol/code/entroprise/src/components/UsersPage/WebRTC.js"],"names":["React","useEffect","useState","useRef","Loadable","firebase","useAuthState","facemesh","tf","tfjsWasm","makeStyles","Container","Box","Typography","Button","Card","CardContent","CardHeader","CardActions","IconButton","List","ListItem","ListItemSecondaryAction","ListItemText","ListItemAvatar","Avatar","IndefiniteLoading","UsersList","fallback","RoomDialog","LocalTracks","useStyles","theme","video","width","WebRTC","classes","mediaStream","setMediaStream","isOnline","setIsOnline","isPredicting","setIsPredicting","videoRef","handleClickUser","console","log","handleDetectFaces","load","model","current","estimateFaces","predictions","length","forEach","prediction","faceInViewConfidence","handleCanPlay","play","enableStream","navigator","mediaDevices","getUserMedia","audio","stream","cleanup","getTracks","track","stop","srcObject"],"mappings":"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","sourcesContent":["import React, { useEffect, useState, useRef } from \"react\"\r\nimport Loadable from \"@loadable/component\"\r\n\r\nimport firebase from \"gatsby-plugin-firebase\"\r\nimport { useAuthState } from \"react-firebase-hooks/auth\"\r\nimport * as facemesh from \"@tensorflow-models/facemesh\"\r\nimport * as tf from \"@tensorflow/tfjs-core\"\r\nimport * as tfjsWasm from \"@tensorflow/tfjs-backend-wasm\"\r\n\r\nimport { makeStyles } from \"@material-ui/core/styles\"\r\nimport {\r\n  Container,\r\n  Box,\r\n  Typography,\r\n  Button,\r\n  Card,\r\n  CardContent,\r\n  CardHeader,\r\n  CardActions,\r\n  IconButton,\r\n  List,\r\n  ListItem,\r\n  ListItemSecondaryAction,\r\n  ListItemText,\r\n  ListItemAvatar,\r\n  Avatar,\r\n} from \"@material-ui/core\"\r\n\r\nimport IndefiniteLoading from \"src/components/loading/indefiniteLoading\"\r\n\r\nconst UsersList = Loadable(() => import(\"./UsersList\"), {\r\n  fallback: <IndefiniteLoading message=\"UsersList\" />,\r\n})\r\n\r\nconst RoomDialog = Loadable(() => import(\"./RoomDialog\"), {\r\n  fallback: <IndefiniteLoading message=\"RoomDialog\" />,\r\n})\r\n\r\nconst LocalTracks = Loadable(() => import(\"./LocalTracks\"), {\r\n  fallback: <IndefiniteLoading message=\"LocalTracks\" />,\r\n})\r\n\r\nconst useStyles = makeStyles(theme => ({\r\n  video: { width: \"100%\" },\r\n}))\r\n\r\nconst WebRTC = () => {\r\n  const classes = useStyles()\r\n\r\n  const [mediaStream, setMediaStream] = useState(null)\r\n  const [isOnline, setIsOnline] = useState(false)\r\n  const [isPredicting, setIsPredicting] = useState(false)\r\n\r\n  const videoRef = useRef()\r\n\r\n  const handleClickUser = () => {\r\n    console.log(\"call user\")\r\n  }\r\n\r\n  const handleDetectFaces = async () => {\r\n    setIsPredicting(true)\r\n    const model = await facemesh.load()\r\n    const current = videoRef.current\r\n    const predictions = await model.estimateFaces(current)\r\n    if (predictions.length > 0) {\r\n      predictions.forEach(prediction => {\r\n        if (prediction.faceInViewConfidence >= 0.8) setIsOnline(true)\r\n        if (prediction.faceInViewConfidence < 0.8) setIsOnline(false)\r\n      })\r\n    }\r\n    setIsPredicting(false)\r\n  }\r\n\r\n  function handleCanPlay() {\r\n    videoRef.current.play()\r\n    handleDetectFaces()\r\n  }\r\n\r\n  useEffect(() => {\r\n    async function enableStream() {\r\n      try {\r\n        const stream = await navigator.mediaDevices.getUserMedia({\r\n          audio: false,\r\n          video: true,\r\n        })\r\n        setMediaStream(stream)\r\n      } catch (err) {\r\n        console.log(err)\r\n      }\r\n    }\r\n\r\n    if (!mediaStream) {\r\n      enableStream()\r\n    } else {\r\n      return function cleanup() {\r\n        mediaStream.getTracks().forEach(track => {\r\n          track.stop()\r\n        })\r\n      }\r\n    }\r\n  }, [mediaStream])\r\n\r\n  if (mediaStream && videoRef.current && !videoRef.current.srcObject) {\r\n    videoRef.current.srcObject = mediaStream\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <Box mt={2} mb={1}>\r\n        <Card variant=\"outlined\">\r\n          <CardHeader title=\"User Status\" />\r\n          <video\r\n            className={classes.video}\r\n            ref={videoRef}\r\n            onCanPlay={handleCanPlay}\r\n            autoPlay\r\n            playsInline\r\n            muted\r\n          />\r\n          {isPredicting && <IndefiniteLoading message=\"Presence\" />}\r\n          <CardContent>\r\n            <Box>\r\n              <Button\r\n                variant=\"contained\"\r\n                color=\"primary\"\r\n                onClick={handleDetectFaces}\r\n              >\r\n                ReCheck Presence\r\n              </Button>\r\n            </Box>\r\n            <Box mt={2} mb={1}>\r\n              {isOnline && <Typography>User is online</Typography>}\r\n            </Box>\r\n          </CardContent>\r\n        </Card>\r\n      </Box>\r\n      <Box mt={2} mb={10}>\r\n        <UsersList callUser={handleClickUser} />\r\n      </Box>\r\n    </>\r\n  )\r\n}\r\nexport default WebRTC\r\n"]},"metadata":{},"sourceType":"module"}